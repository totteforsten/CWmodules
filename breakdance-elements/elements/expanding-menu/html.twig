<div class="exp-menu-wrapper">
  {# Menu Button (stays visible, hamburger animates to X) #}
  <button class="exp-menu-trigger" aria-label="Toggle Menu" aria-expanded="false">

    <span class="menuclose">MENU</span>
    <span class="trigger-icon">
      <span class="icon-line"></span>
      <span class="icon-line"></span>
    </span>
    <span class="trigger-text">{{ content.button.text|default('') }}</span>
  </button>

  {# Expanding Menu Container #}
  <div class="exp-menu-container"
       data-max-width="{{ design.menu.max_width|default('720px') }}"
       data-max-height="{{ design.menu.max_height|default('60vh') }}"
       data-initial-height="{{ design.menu.initial_height|default('80px') }}"
       data-width-duration="{{ design.animation.width_duration|default('0.4') }}"
       data-height-duration="{{ design.animation.height_duration|default('0.4') }}"
       data-stagger="{{ design.animation.stagger|default('0.08') }}"
       data-ease="{{ design.animation.ease|default('power3.out') }}">
    {# Menu Content #}
    <div class="exp-menu-content">
      <div class="exp-menu-grid">
        {# Menu Columns #}
        <div class="exp-menu-columns">
          {% if content.columns.columns %}
            {% for column in content.columns.columns %}
              <div class="exp-column">
                {% if column.title %}
                  <h3 class="exp-column-title">{{ column.title }}</h3>
                {% endif %}
                {% if column.items %}
                  <ul class="exp-column-items">
                    {% for item in column.items %}
                      <li class="exp-item">
                        <a href="{{ item.url|default('#') }}" class="exp-item-link" data-split="anim_navlinks">
                          {{ item.text|default('') }}
                          {% if item.badge %}
                            <span class="exp-item-badge">{{ item.badge }}</span>
                          {% endif %}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>

        {# Featured Section (optional) #}
        {% if content.featured.enabled %}
        <div class="exp-featured">
          {% if content.featured.badge %}
            <span class="exp-featured-badge">{{ content.featured.badge }}</span>
          {% endif %}
          {% if content.featured.title %}
            <h2 class="exp-featured-title">{{ content.featured.title }}</h2>
          {% endif %}
          {% if content.featured.link_url and content.featured.link_text %}
            <a href="{{ content.featured.link_url }}" class="exp-featured-link">
              {{ content.featured.link_text }}
            </a>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Optional Backdrop #}
  <div class="exp-menu-backdrop"></div>
</div>

<script>
/* Expanding Menu Animation Script */
(function() {
  'use strict';
  
  var wrapper = document.currentScript.previousElementSibling;
  if (!wrapper || !wrapper.classList.contains('exp-menu-wrapper')) return;
  
  var trigger = wrapper.querySelector('.exp-menu-trigger');
  var container = wrapper.querySelector('.exp-menu-container');
  var content = wrapper.querySelector('.exp-menu-content');
  var backdrop = wrapper.querySelector('.exp-menu-backdrop');
  var columns = wrapper.querySelectorAll('.exp-column');
  var featured = wrapper.querySelector('.exp-featured');
  
  if (!trigger || !container) return;

  var settings = {
    maxWidth: container.dataset.maxWidth || '720px',
    maxHeight: container.dataset.maxHeight || '60vh',
    initialHeight: container.dataset.initialHeight || '80px',
    widthDuration: parseFloat(container.dataset.widthDuration || '0.4'),
    heightDuration: parseFloat(container.dataset.heightDuration || '0.4'),
    stagger: parseFloat(container.dataset.stagger || '0.08'),
    ease: container.dataset.ease || 'power3.out'
  };

  var isOpen = false;
  var timeline = null;

  function ensureGSAP(callback) {
    if (typeof gsap !== 'undefined') {
      callback();
    } else {
      setTimeout(function() { ensureGSAP(callback); }, 100);
    }
  }

  function openMenu() {
    if (isOpen) return;
    isOpen = true;
    
    trigger.classList.add('is-open');
    trigger.setAttribute('aria-expanded', 'true');
    
    ensureGSAP(function() {
      if (timeline) timeline.kill();
      timeline = gsap.timeline();

      if (backdrop) {
        timeline.to(backdrop, {
          opacity: 1,
          duration: settings.widthDuration,
          ease: settings.ease,
          onStart: function() { backdrop.classList.add('active'); }
        }, 0);
      }

      timeline.to(container, {
        width: settings.maxWidth,
        duration: settings.widthDuration,
        ease: settings.ease
      }, 0);

      timeline.to(container, {
        height: settings.maxHeight,
        duration: settings.heightDuration,
        ease: settings.ease
      }, settings.widthDuration);

      timeline.to(content, {
        opacity: 1,
        duration: 0.3,
        ease: 'power2.out'
      }, settings.widthDuration + (settings.heightDuration * 0.5));

      if (columns.length > 0) {
        timeline.to(columns, {
          opacity: 1,
          y: 0,
          duration: 0.5,
          stagger: settings.stagger,
          ease: 'power3.out'
        }, settings.widthDuration + (settings.heightDuration * 0.5));
      }

      if (featured) {
        timeline.to(featured, {
          opacity: 1,
          y: 0,
          duration: 0.5,
          ease: 'power3.out'
        }, '-=0.3');
      }
    });
  }

  function closeMenu() {
    if (!isOpen) return;
    isOpen = false;

    // ðŸ”¹ Add "is-waiting" on close for 0.5s
    trigger.classList.add('is-waiting');
    setTimeout(function() {
      trigger.classList.remove('is-waiting');
    }, 500);
    
    trigger.classList.remove('is-open');
    trigger.setAttribute('aria-expanded', 'false');

    ensureGSAP(function() {
      if (timeline) timeline.kill();
      timeline = gsap.timeline();

      var fadeElements = [content];
      if (columns.length > 0) {
        for (var i = 0; i < columns.length; i++) {
          fadeElements.push(columns[i]);
        }
      }
      if (featured) fadeElements.push(featured);

      timeline.to(fadeElements, {
        opacity: 0,
        duration: 0.2,
        ease: 'power2.in'
      });

      timeline.to(container, {
        height: settings.initialHeight,
        duration: settings.heightDuration * 0.7,
        ease: 'power2.in'
      }, 0.1);

      timeline.to(container, {
        width: 0,
        duration: settings.widthDuration * 0.7,
        ease: 'power2.in'
      }, 0.1 + (settings.heightDuration * 0.7));

      if (backdrop) {
        timeline.to(backdrop, {
          opacity: 0,
          duration: settings.widthDuration * 0.7,
          ease: 'power2.in',
          onComplete: function() { backdrop.classList.remove('active'); }
        }, 0.1);
      }

      var resetElements = [];
      if (columns.length > 0) {
        for (var i = 0; i < columns.length; i++) {
          resetElements.push(columns[i]);
        }
      }
      if (featured) resetElements.push(featured);
      
      if (resetElements.length > 0) {
        timeline.set(resetElements, { y: 10 });
      }
    });
  }

  trigger.addEventListener('click', function(e) {
    e.preventDefault();
    if (isOpen) {
      closeMenu();
    } else {
      openMenu();
    }
  });

  if (backdrop) {
    backdrop.addEventListener('click', closeMenu);
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isOpen) {
      closeMenu();
    }
  });
})();
</script>
