<div class="bde-promo-banner__wrapper"
     data-cookie-name="{{ content.close_button.cookie_name|default('promo_banner_closed') }}"
     data-cookie-days="{{ content.close_button.cookie_days|default(1) }}"
     data-banner-mode="{{ content.banner_mode|default('countdown') }}"
     {% if content.banner_mode != 'marquee' %}
     data-countdown-type="{{ content.countdown.countdown_type|default('duration') }}"
     data-countdown-hours="{{ content.countdown.hours|default(24) }}"
     data-countdown-end-date="{{ content.countdown.end_date }}"
     data-countdown-end-time="{{ content.countdown.end_time|default('23:59') }}"
     data-hide-expired="{{ content.countdown.hide_when_expired ? 'true' : 'false' }}"
     {% endif %}
     {% if content.banner_mode != 'countdown' %}
     data-marquee-speed="{{ content.marquee.speed|default(30) }}"
     data-marquee-direction="{{ content.marquee.direction|default('left') }}"
     data-marquee-pause="{{ content.marquee.pause_on_hover ? 'true' : 'false' }}"
     {% endif %}>

    {% if content.banner_mode == 'countdown' or content.banner_mode == 'both' %}
    <div class="bde-promo-banner__countdown-section">
        {% if content.countdown.link.url %}
        <a href="{{ content.countdown.link.url }}" class="bde-promo-banner__countdown-link" {% if content.countdown.link.openInNewTab %}target="_blank" rel="noopener noreferrer"{% endif %}>
        {% endif %}
            <span class="bde-promo-banner__text-before">{{ content.countdown.text_before }}</span>
            <span class="bde-promo-banner__timer">
                <span class="bde-promo-banner__time-unit">
                    <span class="bde-promo-banner__hours">00</span><span class="bde-promo-banner__separator">:</span>
                </span>
                <span class="bde-promo-banner__time-unit">
                    <span class="bde-promo-banner__minutes">00</span><span class="bde-promo-banner__separator">:</span>
                </span>
                <span class="bde-promo-banner__time-unit">
                    <span class="bde-promo-banner__seconds">00</span>
                </span>
            </span>
            <span class="bde-promo-banner__text-after">{{ content.countdown.text_after }}</span>
            {% if content.countdown.link_text %}
            <span class="bde-promo-banner__link-text">{{ content.countdown.link_text }}</span>
            {% endif %}
        {% if content.countdown.link.url %}
        </a>
        {% endif %}
        <span class="bde-promo-banner__expired" style="display: none;">{{ content.countdown.expired_text|default('Offer has expired!') }}</span>
    </div>
    {% endif %}

    {% if content.banner_mode == 'marquee' or content.banner_mode == 'both' %}
    <div class="bde-promo-banner__marquee-section">
        <div class="bde-promo-banner__marquee-track">
            {% for item in content.marquee.items %}
            <div class="bde-promo-banner__marquee-item">
                {% if item.link.url %}<a href="{{ item.link.url }}" {% if item.link.openInNewTab %}target="_blank" rel="noopener noreferrer"{% endif %}>{% endif %}
                {% if item.icon and item.icon != '' and item.icon != 'custom' %}
                <span class="bde-promo-banner__icon" data-icon="{{ item.icon }}">
                    {% if item.icon == 'TruckIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                    {% elseif item.icon == 'ShieldCheckIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><polyline points="9 12 11 14 15 10"></polyline></svg>
                    {% elseif item.icon == 'ChatIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    {% elseif item.icon == 'StarIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    {% elseif item.icon == 'GiftIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>
                    {% elseif item.icon == 'TagIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                    {% elseif item.icon == 'ClockIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    {% elseif item.icon == 'HeartIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    {% elseif item.icon == 'CheckIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    {% elseif item.icon == 'PercentIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>
                    {% elseif item.icon == 'CreditCardIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    {% elseif item.icon == 'LockIcon' %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    {% endif %}
                </span>
                {% elseif item.icon == 'custom' and item.custom_icon %}
                <span class="bde-promo-banner__icon bde-promo-banner__icon--custom">{{ item.custom_icon|raw }}</span>
                {% endif %}
                <span class="bde-promo-banner__marquee-text">{{ item.text }}</span>
                {% if item.link.url %}</a>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if content.close_button.show %}
    <button class="bde-promo-banner__close" aria-label="Close banner" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    {% endif %}
</div>

<script>
(function() {
    'use strict';

    var wrapper = document.currentScript.previousElementSibling;
    var banner = wrapper.closest('.bde-promo-banner');

    // Cookie functions
    function setCookie(name, value, days) {
        var expires = '';
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = '; expires=' + date.toUTCString();
        }
        document.cookie = name + '=' + (value || '') + expires + '; path=/; SameSite=Lax';
    }

    function getCookie(name) {
        var nameEQ = name + '=';
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Get settings from data attributes
    var cookieName = wrapper.dataset.cookieName || 'promo_banner_closed';
    var cookieDays = parseInt(wrapper.dataset.cookieDays, 10) || 1;
    var bannerMode = wrapper.dataset.bannerMode || 'countdown';

    // Check if banner should be hidden
    if (getCookie(cookieName)) {
        banner.style.display = 'none';
        return;
    }

    // Close button functionality
    var closeBtn = wrapper.querySelector('.bde-promo-banner__close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            setCookie(cookieName, 'true', cookieDays);
            banner.style.display = 'none';
        });
    }

    // Countdown timer functionality
    if (bannerMode === 'countdown' || bannerMode === 'both') {
        var countdownType = wrapper.dataset.countdownType || 'duration';
        var endTime;

        if (countdownType === 'duration') {
            var hours = parseInt(wrapper.dataset.countdownHours, 10) || 24;
            var storedEndTime = localStorage.getItem('promo_banner_end_' + cookieName);

            if (storedEndTime && parseInt(storedEndTime, 10) > Date.now()) {
                endTime = parseInt(storedEndTime, 10);
            } else {
                endTime = Date.now() + (hours * 60 * 60 * 1000);
                localStorage.setItem('promo_banner_end_' + cookieName, endTime.toString());
            }
        } else if (countdownType === 'fixed') {
            var endDate = wrapper.dataset.countdownEndDate;
            var endTimeStr = wrapper.dataset.countdownEndTime || '23:59';
            if (endDate) {
                endTime = new Date(endDate + 'T' + endTimeStr + ':00').getTime();
            }
        } else if (countdownType === 'daily') {
            var dailyEndTime = wrapper.dataset.countdownEndTime || '23:59';
            var today = new Date();
            var timeParts = dailyEndTime.split(':');
            endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(),
                parseInt(timeParts[0], 10), parseInt(timeParts[1], 10), 0).getTime();

            // If end time has passed today, set to tomorrow
            if (endTime < Date.now()) {
                endTime += 24 * 60 * 60 * 1000;
            }
        }

        var hoursEl = wrapper.querySelector('.bde-promo-banner__hours');
        var minutesEl = wrapper.querySelector('.bde-promo-banner__minutes');
        var secondsEl = wrapper.querySelector('.bde-promo-banner__seconds');
        var timerEl = wrapper.querySelector('.bde-promo-banner__timer');
        var expiredEl = wrapper.querySelector('.bde-promo-banner__expired');
        var countdownSection = wrapper.querySelector('.bde-promo-banner__countdown-section');
        var hideWhenExpired = wrapper.dataset.hideExpired === 'true';

        function updateCountdown() {
            var now = Date.now();
            var diff = endTime - now;

            if (diff <= 0) {
                // Timer expired
                if (hideWhenExpired) {
                    banner.style.display = 'none';
                } else if (expiredEl && countdownSection) {
                    var textBefore = wrapper.querySelector('.bde-promo-banner__text-before');
                    var textAfter = wrapper.querySelector('.bde-promo-banner__text-after');
                    var linkText = wrapper.querySelector('.bde-promo-banner__link-text');
                    if (timerEl) timerEl.style.display = 'none';
                    if (textBefore) textBefore.style.display = 'none';
                    if (textAfter) textAfter.style.display = 'none';
                    if (linkText) linkText.style.display = 'none';
                    expiredEl.style.display = 'inline';
                }
                return;
            }

            var totalSeconds = Math.floor(diff / 1000);
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = totalSeconds % 60;

            if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
            if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
            if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');

            requestAnimationFrame(function() {
                setTimeout(updateCountdown, 1000 - (Date.now() % 1000));
            });
        }

        if (endTime) {
            updateCountdown();
        }
    }

    // Marquee functionality - true infinite scroll with item recycling
    if (bannerMode === 'marquee' || bannerMode === 'both') {
        var track = wrapper.querySelector('.bde-promo-banner__marquee-track');
        var section = wrapper.querySelector('.bde-promo-banner__marquee-section');
        var speed = parseFloat(wrapper.dataset.marqueeSpeed) || 30;
        var direction = wrapper.dataset.marqueeDirection || 'left';
        var pauseOnHover = wrapper.dataset.marqueePause === 'true';
        var gap = 60;

        if (track && section) {
            var originalItems = Array.from(track.querySelectorAll('.bde-promo-banner__marquee-item'));
            if (originalItems.length === 0) return;

            var allItems = [];
            var totalWidth = 0;
            var totalOriginalWidth = 0;
            var containerWidth = 0;
            var scrollPosition = 0;
            var isPaused = false;
            var lastTime = null;
            var pixelsPerSecond = 0;
            var initialized = false;

            function initMarquee() {
                containerWidth = section.offsetWidth;

                // Remove previously added clones
                var clones = track.querySelectorAll('.bde-promo-banner__marquee-item[aria-hidden="true"]');
                clones.forEach(function(clone) { clone.remove(); });

                // Reset original items positioning
                originalItems.forEach(function(item) {
                    item.style.position = '';
                    item.style.transform = '';
                });

                // Calculate item widths
                var itemWidths = originalItems.map(function(item) {
                    return item.offsetWidth + gap;
                });
                totalOriginalWidth = itemWidths.reduce(function(a, b) { return a + b; }, 0);

                // Clone items until we have enough to fill screen + buffer
                var clonesNeeded = Math.ceil((containerWidth * 3) / totalOriginalWidth) + 1;
                for (var c = 0; c < clonesNeeded; c++) {
                    originalItems.forEach(function(item) {
                        var clone = item.cloneNode(true);
                        clone.setAttribute('aria-hidden', 'true');
                        track.appendChild(clone);
                    });
                }

                // Get all items including clones
                allItems = Array.from(track.querySelectorAll('.bde-promo-banner__marquee-item'));

                // Position each item
                var currentOffset = 0;
                allItems.forEach(function(item) {
                    item.style.position = 'absolute';
                    item.style.left = '0';
                    item.style.top = '0';
                    item.style.transform = 'translateX(' + currentOffset + 'px)';
                    item.dataset.offset = currentOffset;
                    currentOffset += item.offsetWidth + gap;
                });

                totalWidth = currentOffset;
                pixelsPerSecond = totalOriginalWidth / speed;

                // Set track dimensions
                track.style.position = 'relative';
                track.style.height = originalItems[0].offsetHeight + 'px';
                track.style.width = '100%';

                initialized = true;
            }

            function animate(timestamp) {
                if (!initialized) {
                    requestAnimationFrame(animate);
                    return;
                }

                if (!lastTime) lastTime = timestamp;
                var delta = timestamp - lastTime;
                lastTime = timestamp;

                if (!isPaused && delta < 100) {
                    if (direction === 'left') {
                        scrollPosition += (delta / 1000) * pixelsPerSecond;
                    } else {
                        scrollPosition -= (delta / 1000) * pixelsPerSecond;
                    }

                    // Wrap scroll position
                    while (scrollPosition >= totalOriginalWidth) {
                        scrollPosition -= totalOriginalWidth;
                    }
                    while (scrollPosition < 0) {
                        scrollPosition += totalOriginalWidth;
                    }

                    // Update each item position
                    allItems.forEach(function(item) {
                        var baseOffset = parseFloat(item.dataset.offset);
                        var newPos = baseOffset - scrollPosition;

                        while (newPos < -item.offsetWidth - gap) {
                            newPos += totalWidth;
                        }
                        while (newPos > containerWidth + totalOriginalWidth) {
                            newPos -= totalWidth;
                        }

                        item.style.transform = 'translateX(' + newPos + 'px)';
                    });
                }

                requestAnimationFrame(animate);
            }

            // Initialize
            initMarquee();
            requestAnimationFrame(animate);

            // Handle resize
            var resizeTimeout;
            var lastWidth = containerWidth;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    var newWidth = section.offsetWidth;
                    if (newWidth !== lastWidth) {
                        scrollPosition = 0;
                        lastWidth = newWidth;
                        initMarquee();
                        lastTime = null;
                    }
                }, 150);
            });

            if (pauseOnHover) {
                section.addEventListener('mouseenter', function() {
                    isPaused = true;
                });
                section.addEventListener('mouseleave', function() {
                    isPaused = false;
                    lastTime = null;
                });
            }
        }
    }
})();
</script>
